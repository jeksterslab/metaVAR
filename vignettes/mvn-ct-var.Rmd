---
title: "Multivariate Normal (Continuous-Time Vector Autoregressive Model)"
author: Ivan Jacob Agaloos Pesigan
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Multivariate Normal (Continuous-Time Vector Autoregressive Model)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---







## Model

The measurement model is given by
\begin{equation}
  \mathbf{y}_{i, t}
  =
  \boldsymbol{\nu}
  +
  \boldsymbol{\Lambda}
  \boldsymbol{\eta}_{i, t}
  +
  \boldsymbol{\varepsilon}_{i, t},
  \quad
  \mathrm{with}
  \quad
  \boldsymbol{\varepsilon}_{i, t}
  \sim
  \mathcal{N}
  \left(
  \mathbf{0},
  \boldsymbol{\Theta}
  \right)
\end{equation}
where
$\mathbf{y}_{i, t}$,
$\boldsymbol{\eta}_{i, t}$,
and
$\boldsymbol{\varepsilon}_{i, t}$
are random variables
and
$\boldsymbol{\nu}$,
$\boldsymbol{\Lambda}$,
and
$\boldsymbol{\Theta}$
are model parameters.
$\mathbf{y}_{i, t}$
represents a vector of observed random variables,
$\boldsymbol{\eta}_{i, t}$
a vector of latent random variables,
and
$\boldsymbol{\varepsilon}_{i, t}$
a vector of random measurement errors,
at time $t$ and individual $i$.
$\boldsymbol{\nu}$
denotes a vector of intercepts,
$\boldsymbol{\Lambda}$
a matrix of factor loadings,
and
$\boldsymbol{\Theta}$
the covariance matrix of
$\boldsymbol{\varepsilon}$.

An alternative representation of the measurement error
is given by
\begin{equation}
  \boldsymbol{\varepsilon}_{i, t}
  =
  \boldsymbol{\Theta}^{\frac{1}{2}}
  \mathbf{z}_{i, t},
  \quad
  \mathrm{with}
  \quad
  \mathbf{z}_{i, t}
  \sim
  \mathcal{N}
  \left(
  \mathbf{0},
  \mathbf{I}
  \right)
\end{equation}
where
$\mathbf{z}_{i, t}$ is a vector of
independent standard normal random variables and
$\left( \boldsymbol{\Theta}^{\frac{1}{2}} \right) \left( \boldsymbol{\Theta}^{\frac{1}{2}} \right)^{\prime} = \boldsymbol{\Theta}$ .

The dynamic structure is given by
\begin{equation}
  \mathrm{d} \boldsymbol{\eta}_{i, t}
  =
  \boldsymbol{\Phi}
  \left(
  \boldsymbol{\eta}_{i, t}
  -
  \boldsymbol{\mu}
  \right)
  \mathrm{d}t
  +
  \boldsymbol{\Sigma}^{\frac{1}{2}}
  \mathrm{d}
  \mathbf{W}_{i, t}
\end{equation}
where
$\boldsymbol{\mu}$
is the long-term mean or equilibrium level,
$\boldsymbol{\Phi}$
is the rate of mean reversion,
determining how quickly the variable returns to its mean,
$\boldsymbol{\Sigma}$
is the matrix of volatility
or randomness in the process, and
$\mathrm{d}\boldsymbol{W}$
is a Wiener process or Brownian motion,
which represents random fluctuations.

## Data Generation

### Notation

Let $t = 100$ be the number of time points and $n = 100$ be the number of individuals.

Let the measurement model intecept vector $\boldsymbol{\nu}$ be given by

\begin{equation}
\boldsymbol{\nu}
=
\left(
\begin{array}{c}
  0 \\
  0 \\
  0 \\
\end{array}
\right) .
\end{equation}

Let the factor loadings matrix $\boldsymbol{\Lambda}$ be given by

\begin{equation}
\boldsymbol{\Lambda}
=
\left(
\begin{array}{ccc}
  1 & 0 & 0 \\
  0 & 1 & 0 \\
  0 & 0 & 1 \\
\end{array}
\right) .
\end{equation}

Let the measurement error covariance matrix $\boldsymbol{\Theta}$ be given by

\begin{equation}
\boldsymbol{\Theta}
=
\left(
\begin{array}{ccc}
  0.2 & 0 & 0 \\
  0 & 0.2 & 0 \\
  0 & 0 & 0.2 \\
\end{array}
\right) .
\end{equation}

Let the initial condition
$\boldsymbol{\eta}_{0}$
be given by

\begin{equation}
\boldsymbol{\eta}_{0} \sim \mathcal{N} \left( \boldsymbol{\mu}_{\boldsymbol{\eta} \mid 0}, \boldsymbol{\Sigma}_{\boldsymbol{\eta} \mid 0} \right)
\end{equation}

\begin{equation}
\boldsymbol{\mu}_{\boldsymbol{\eta} \mid 0}
=
\left(
\begin{array}{c}
  0 \\
  0 \\
  0 \\
\end{array}
\right)
\end{equation}

\begin{equation}
\boldsymbol{\Sigma}_{\boldsymbol{\eta} \mid 0}
=
\left(
\begin{array}{ccc}
  1 & 0.2 & 0.2 \\
  0.2 & 1 & 0.2 \\
  0.2 & 0.2 & 1 \\
\end{array}
\right) .
\end{equation}

Let the long-term mean vector $\boldsymbol{\mu}$ be given by

\begin{equation}
\boldsymbol{\mu}
=
\left(
\begin{array}{c}
  0 \\
  0 \\
  0 \\
\end{array}
\right) .
\end{equation}

Let the drift matrix $\boldsymbol{\Phi}$ be normally distributed with the following means

\begin{equation}
\left(
\begin{array}{ccc}
  -0.357 & 0 & 0 \\
  0.771 & -0.511 & 0 \\
  -0.45 & 0.729 & -0.693 \\
\end{array}
\right)
\end{equation}

and covariance matrix

\begin{equation}
\left(
\begin{array}{ccc}
  0.1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0.1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0.1 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0.1 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0.1 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0.1 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0.1 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0 & 0.1 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0.1 \\
\end{array}
\right) .
\end{equation}

> **_NOTE:_**  This example depends on the development version of simStateSpace (1.2.1.9000).

The SimPhiN function from the simStateSpace package generates random drift matrices from the multivariate normal distribution. Note that the function generates drift matrices that are stable.

Let the dynamic process noise covariance matrix $\boldsymbol{\Sigma}$ be given by

\begin{equation}
\boldsymbol{\Sigma}
=
\left(
\begin{array}{ccc}
  0.1 & 0 & 0 \\
  0 & 0.1 & 0 \\
  0 & 0 & 0.1 \\
\end{array}
\right) .
\end{equation}

Let $\Delta t = 0.1$.

### R Function Arguments


``` r
n
#> [1] 100
```

``` r
time
#> [1] 100
```

``` r
delta_t
#> [1] 0.1
```

``` r
mu0
#> [[1]]
#> [1] 0 0 0
```

``` r
sigma0
#>      [,1] [,2] [,3]
#> [1,]  1.0  0.2  0.2
#> [2,]  0.2  1.0  0.2
#> [3,]  0.2  0.2  1.0
```

``` r
sigma0_l
#> [[1]]
#>      [,1]      [,2]      [,3]
#> [1,]  1.0 0.0000000 0.0000000
#> [2,]  0.2 0.9797959 0.0000000
#> [3,]  0.2 0.1632993 0.9660918
```

``` r
mu
#> [[1]]
#> [1] 0 0 0
```

``` r
# first phi in the list of length n
phi[[1]]
#>            [,1]       [,2]         [,3]
#> [1,] -0.3294613  0.2220243 -0.267871122
#> [2,]  0.7555052 -0.8564506  0.009117024
#> [3,] -0.4690264  1.5625820 -0.761826607
```

``` r
sigma
#>      [,1] [,2] [,3]
#> [1,]  0.1  0.0  0.0
#> [2,]  0.0  0.1  0.0
#> [3,]  0.0  0.0  0.1
```

``` r
sigma_l
#> [[1]]
#>           [,1]      [,2]      [,3]
#> [1,] 0.3162278 0.0000000 0.0000000
#> [2,] 0.0000000 0.3162278 0.0000000
#> [3,] 0.0000000 0.0000000 0.3162278
```

``` r
nu
#> [[1]]
#> [1] 0 0 0
```

``` r
lambda
#> [[1]]
#>      [,1] [,2] [,3]
#> [1,]    1    0    0
#> [2,]    0    1    0
#> [3,]    0    0    1
```

``` r
theta
#>      [,1] [,2] [,3]
#> [1,]  0.2  0.0  0.0
#> [2,]  0.0  0.2  0.0
#> [3,]  0.0  0.0  0.2
```

``` r
theta_l
#> [[1]]
#>           [,1]      [,2]      [,3]
#> [1,] 0.4472136 0.0000000 0.0000000
#> [2,] 0.0000000 0.4472136 0.0000000
#> [3,] 0.0000000 0.0000000 0.4472136
```

### Visualizing the Dynamics Without Process Noise (n = 5 with Different Initial Condition)

<img src="fig-vignettes-mvn-ct-var-no-error-1.png" width="3300" /><img src="fig-vignettes-mvn-ct-var-no-error-2.png" width="3300" /><img src="fig-vignettes-mvn-ct-var-no-error-3.png" width="3300" />

### Using the SimSSMVARIVary Function from the simStateSpace Package to Simulate Data


``` r
library(simStateSpace)
sim <- SimSSMOUIVary(
  n = n,
  time = time,
  delta_t = delta_t,
  mu0 = mu0,
  sigma0_l = sigma0_l,
  mu = mu,
  phi = phi,
  sigma_l = sigma_l,
  nu = nu,
  lambda = lambda,
  theta_l = theta_l
)
data <- as.data.frame(sim)
head(data)
#>   id time          y1         y2         y3
#> 1  1  0.0 -1.19644781 0.49271983 -2.3660203
#> 2  1  0.1 -0.01587099 0.70912395 -2.8300621
#> 3  1  0.2 -0.48096294 0.64019340 -1.2868955
#> 4  1  0.3 -0.95279458 0.18238850 -0.9662149
#> 5  1  0.4 -1.10615730 0.73350206 -1.0840208
#> 6  1  0.5 -0.88790356 0.08854986 -0.9735429
```

``` r
plot(sim)
```

<img src="fig-vignettes-mvn-ct-var-error-1.png" width="3300" /><img src="fig-vignettes-mvn-ct-var-error-2.png" width="3300" /><img src="fig-vignettes-mvn-ct-var-error-3.png" width="3300" />

## Model Fitting

The FitCTVAR function fits a CT-VAR model on each individual $i$.





``` r
library(metaVAR)
fit <- FitCTVAR(
  data = data,
  observed = paste0("y", seq_len(k)),
  id = "id",
  time = "time",
  phi_start = phi_mu,
  sigma_start = diag(sigma),
  ncores = parallel::detectCores()
)
```

## Multivariate Meta-Analysis

The Meta function performs multivariate meta-analysis using the estimated drift matrices $\boldsymbol{\Phi}$
and the corresponding sampling variance-covariance matrix for each individual $i$.


``` r
meta <- Meta(
  fit,
  ncores = parallel::detectCores()
)
#> Running Model with 54 parameters
#> 
#> Beginning initial fit attempt
#> Running Model with 54 parameters
#> 
#>  Lowest minimum so far:  303545.70157416
#> 
#> Solution found
```



```
#> 
#>  Solution found!  Final fit=303545.7 (started at 2961628.9)  (1 attempt(s): 1 valid, 0 errors)
#>  Start values from best fit:
#> 3.10772239673876,0.207306535419174,-0.115658180680931,-0.132860320205029,0.449723944354106,0.301176726254694,0.0829105117698353,-0.041176406646159,0.0715010470614404,3.27393592896371,-0.114513436261444,-0.777850813893521,-0.192742726793029,-0.289724878907706,0.536055799493342,0.60453236124532,-0.147569433515701,3.66049324638713,1.08183137300808,-0.448332124414668,-1.07131132075088,-0.599183250421764,0.481880890613347,0.17482736811048,3.43357689738807,0.412229803154735,0.0592702381770512,-0.941241833624175,-0.54049197337942,-0.228110374414848,3.08502414195818,0.139287329581488,-0.553793645064184,-0.280652627235201,0.0324141234375147,3.244501918505,1.11310022791934,-0.817713206782808,-0.219526757284226,3.23548589059944,-0.341214846863712,0.285415608786323,3.20991783330269,0.167660037251673,3.26172398959502,-8.08493748352544,2.05990949418683,-0.804005211180998,1.21695606420523,-7.27346560570279,1.77899758552575,-0.502974718439586,1.27567975767187,-7.78014207096424
```

``` r
summary(meta)
#>              est     se         z      p    2.5%   97.5%
#> sigma_11  9.6579 0.1366   70.7112 0.0000  9.3902  9.9256
#> sigma_21  0.6443 0.1022    6.3050 0.0000  0.4440  0.8445
#> sigma_31 -0.3594 0.1139   -3.1546 0.0016 -0.5827 -0.1361
#> sigma_41 -0.4129 0.1146   -3.6044 0.0003 -0.6374 -0.1884
#> sigma_51  1.3976 0.0999   13.9848 0.0000  1.2017  1.5935
#> sigma_61  0.9360 0.1075    8.7085 0.0000  0.7253  1.1466
#> sigma_71  0.2577 0.1144    2.2532 0.0242  0.0335  0.4818
#> sigma_81 -0.1280 0.1079   -1.1861 0.2356 -0.3394  0.0835
#> sigma_91  0.2222 0.1027    2.1638 0.0305  0.0209  0.4235
#> sigma_22 10.7616 0.1522   70.7082 0.0000 10.4633 11.0599
#> sigma_32 -0.3989 0.1202   -3.3181 0.0009 -0.6345 -0.1633
#> sigma_42 -2.5742 0.1236  -20.8204 0.0000 -2.8165 -2.3319
#> sigma_52 -0.5378 0.1045   -5.1452 0.0000 -0.7427 -0.3329
#> sigma_62 -0.8861 0.1134   -7.8170 0.0000 -1.1083 -0.6639
#> sigma_72  1.7722 0.1222   14.5010 0.0000  1.5327  2.0117
#> sigma_82  1.9707 0.1157   17.0353 0.0000  1.7439  2.1974
#> sigma_92 -0.4683 0.1085   -4.3173 0.0000 -0.6809 -0.2557
#> sigma_33 13.4257 0.1898   70.7227 0.0000 13.0536 13.7978
#> sigma_43  4.0645 0.1410   28.8321 0.0000  3.7882  4.3408
#> sigma_53 -1.6711 0.1178  -14.1857 0.0000 -1.9019 -1.4402
#> sigma_63 -3.9232 0.1321  -29.6914 0.0000 -4.1822 -3.6642
#> sigma_73 -2.2643 0.1367  -16.5595 0.0000 -2.5323 -1.9963
#> sigma_83  1.6995 0.1284   13.2319 0.0000  1.4477  1.9512
#> sigma_93  0.6486 0.1211    5.3542 0.0000  0.4112  0.8860
#> sigma_44 13.5825 0.1921   70.7159 0.0000 13.2061 13.9590
#> sigma_54  1.0206 0.1177    8.6680 0.0000  0.7898  1.2513
#> sigma_64 -0.7701 0.1272   -6.0523 0.0000 -1.0195 -0.5207
#> sigma_74 -4.3080 0.1424  -30.2530 0.0000 -4.5871 -4.0289
#> sigma_84 -1.7993 0.1293  -13.9204 0.0000 -2.0526 -1.5459
#> sigma_94 -0.4888 0.1218   -4.0122 0.0001 -0.7276 -0.2500
#> sigma_55 10.1277 0.1432   70.7044 0.0000  9.8470 10.4085
#> sigma_65  1.1257 0.1102   10.2163 0.0000  0.9098  1.3417
#> sigma_75 -1.8939 0.1187  -15.9527 0.0000 -2.1266 -1.6612
#> sigma_85 -1.4397 0.1115  -12.9148 0.0000 -1.6582 -1.2212
#> sigma_95 -0.0118 0.1051   -0.1124 0.9105 -0.2178  0.1942
#> sigma_66 11.8721 0.1679   70.7232 0.0000 11.5431 12.2011
#> sigma_76  3.9901 0.1329   30.0158 0.0000  3.7296  4.2507
#> sigma_86 -3.4280 0.1244  -27.5469 0.0000 -3.6719 -3.1841
#> sigma_96 -0.8443 0.1141   -7.3970 0.0000 -1.0680 -0.6206
#> sigma_77 13.5532 0.1917   70.7085 0.0000 13.1776 13.9289
#> sigma_87 -1.3181 0.1286  -10.2506 0.0000 -1.5702 -1.0661
#> sigma_97  0.6979 0.1218    5.7311 0.0000  0.4592  0.9366
#> sigma_88 12.0589 0.1706   70.7030 0.0000 11.7246 12.3932
#> sigma_98  0.7266 0.1149    6.3217 0.0000  0.5013  0.9518
#> sigma_99 10.9071 0.1543   70.7077 0.0000 10.6048 11.2095
#> mu_1     -8.0849 0.0311 -260.1559 0.0000 -8.1458 -8.0240
#> mu_2      2.0599 0.0328   62.7964 0.0000  1.9956  2.1242
#> mu_3     -0.8040 0.0366  -21.9457 0.0000 -0.8758 -0.7322
#> mu_4      1.2170 0.0369   33.0109 0.0000  1.1447  1.2892
#> mu_5     -7.2735 0.0318 -228.5566 0.0000 -7.3358 -7.2111
#> mu_6      1.7790 0.0345   51.6312 0.0000  1.7115  1.8465
#> mu_7     -0.5030 0.0368  -13.6619 0.0000 -0.5751 -0.4308
#> mu_8      1.2757 0.0348   36.7085 0.0000  1.2076  1.3438
#> mu_9     -7.7801 0.0330 -235.5791 0.0000 -7.8449 -7.7154
```
