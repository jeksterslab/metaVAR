---
title: "Multivariate Normal (Continuous-Time Vector Autoregressive Model)"
author: Ivan Jacob Agaloos Pesigan
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Multivariate Normal (Continuous-Time Vector Autoregressive Model)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---







## Model

The measurement model is given by
\begin{equation}
  \mathbf{y}_{i, t}
  =
  \boldsymbol{\nu}
  +
  \boldsymbol{\Lambda}
  \boldsymbol{\eta}_{i, t}
  +
  \boldsymbol{\varepsilon}_{i, t},
  \quad
  \mathrm{with}
  \quad
  \boldsymbol{\varepsilon}_{i, t}
  \sim
  \mathcal{N}
  \left(
  \mathbf{0},
  \boldsymbol{\Theta}
  \right)
\end{equation}
where
$\mathbf{y}_{i, t}$,
$\boldsymbol{\eta}_{i, t}$,
and
$\boldsymbol{\varepsilon}_{i, t}$
are random variables
and
$\boldsymbol{\nu}$,
$\boldsymbol{\Lambda}$,
and
$\boldsymbol{\Theta}$
are model parameters.
$\mathbf{y}_{i, t}$
represents a vector of observed random variables,
$\boldsymbol{\eta}_{i, t}$
a vector of latent random variables,
and
$\boldsymbol{\varepsilon}_{i, t}$
a vector of random measurement errors,
at time $t$ and individual $i$.
$\boldsymbol{\nu}$
denotes a vector of intercepts,
$\boldsymbol{\Lambda}$
a matrix of factor loadings,
and
$\boldsymbol{\Theta}$
the covariance matrix of
$\boldsymbol{\varepsilon}$.

An alternative representation of the measurement error
is given by
\begin{equation}
  \boldsymbol{\varepsilon}_{i, t}
  =
  \boldsymbol{\Theta}^{\frac{1}{2}}
  \mathbf{z}_{i, t},
  \quad
  \mathrm{with}
  \quad
  \mathbf{z}_{i, t}
  \sim
  \mathcal{N}
  \left(
  \mathbf{0},
  \mathbf{I}
  \right)
\end{equation}
where
$\mathbf{z}_{i, t}$ is a vector of
independent standard normal random variables and
$\left( \boldsymbol{\Theta}^{\frac{1}{2}} \right) \left( \boldsymbol{\Theta}^{\frac{1}{2}} \right)^{\prime} = \boldsymbol{\Theta}$ .

The dynamic structure is given by
\begin{equation}
  \mathrm{d} \boldsymbol{\eta}_{i, t}
  =
  \boldsymbol{\Phi}
  \left(
  \boldsymbol{\eta}_{i, t}
  -
  \boldsymbol{\mu}
  \right)
  \mathrm{d}t
  +
  \boldsymbol{\Sigma}^{\frac{1}{2}}
  \mathrm{d}
  \mathbf{W}_{i, t}
\end{equation}
where
$\boldsymbol{\mu}$
is the long-term mean or equilibrium level,
$\boldsymbol{\Phi}$
is the rate of mean reversion,
determining how quickly the variable returns to its mean,
$\boldsymbol{\Sigma}$
is the matrix of volatility
or randomness in the process, and
$\mathrm{d}\boldsymbol{W}$
is a Wiener process or Brownian motion,
which represents random fluctuations.

## Data Generation

### Notation

Let $t = 100$ be the number of time points and $n = 100$ be the number of individuals.

Let the measurement model intecept vector $\boldsymbol{\nu}$ be given by

\begin{equation}
\boldsymbol{\nu}
=
\left(
\begin{array}{c}
  0 \\
  0 \\
  0 \\
\end{array}
\right) .
\end{equation}

Let the factor loadings matrix $\boldsymbol{\Lambda}$ be given by

\begin{equation}
\boldsymbol{\Lambda}
=
\left(
\begin{array}{ccc}
  1 & 0 & 0 \\
  0 & 1 & 0 \\
  0 & 0 & 1 \\
\end{array}
\right) .
\end{equation}

Let the measurement error covariance matrix $\boldsymbol{\Theta}$ be given by

\begin{equation}
\boldsymbol{\Theta}
=
\left(
\begin{array}{ccc}
  0.2 & 0 & 0 \\
  0 & 0.2 & 0 \\
  0 & 0 & 0.2 \\
\end{array}
\right) .
\end{equation}

Let the initial condition
$\boldsymbol{\eta}_{0}$
be given by

\begin{equation}
\boldsymbol{\eta}_{0} \sim \mathcal{N} \left( \boldsymbol{\mu}_{\boldsymbol{\eta} \mid 0}, \boldsymbol{\Sigma}_{\boldsymbol{\eta} \mid 0} \right)
\end{equation}

\begin{equation}
\boldsymbol{\mu}_{\boldsymbol{\eta} \mid 0}
=
\left(
\begin{array}{c}
  0 \\
  0 \\
  0 \\
\end{array}
\right)
\end{equation}

\begin{equation}
\boldsymbol{\Sigma}_{\boldsymbol{\eta} \mid 0}
=
\left(
\begin{array}{ccc}
  0.01 & 0 & 0 \\
  0 & 0.01 & 0 \\
  0 & 0 & 0.01 \\
\end{array}
\right) .
\end{equation}

Let the long-term mean vector $\boldsymbol{\mu}$ be given by

\begin{equation}
\boldsymbol{\mu}
=
\left(
\begin{array}{c}
  0 \\
  0 \\
  0 \\
\end{array}
\right) .
\end{equation}

Let the drift matrix $\boldsymbol{\Phi}$ be normally distributed with the following means

\begin{equation}
\left(
\begin{array}{ccc}
  -0.357 & 0 & 0 \\
  0.771 & -0.511 & 0 \\
  -0.45 & 0.729 & -0.693 \\
\end{array}
\right)
\end{equation}

and covariance matrix

\begin{equation}
\left(
\begin{array}{ccc}
  0.01 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0.01 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0.01 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0.01 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0.01 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0.01 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0.01 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0 & 0.01 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0.01 \\
\end{array}
\right) .
\end{equation}

> **_NOTE:_**  This example depends on the development version of simStateSpace (1.2.1.9000).

The SimPhiN function from the simStateSpace package generates random drift matrices from the multivariate normal distribution. Note that the function generates drift matrices that are stable.

Let the dynamic process noise covariance matrix $\boldsymbol{\Sigma}$ be given by

\begin{equation}
\boldsymbol{\Sigma}
=
\left(
\begin{array}{ccc}
  0.1 & 0 & 0 \\
  0 & 0.1 & 0 \\
  0 & 0 & 0.1 \\
\end{array}
\right) .
\end{equation}

Let $\Delta t = 0.1$.

### R Function Arguments


``` r
n
#> [1] 100
```

``` r
time
#> [1] 100
```

``` r
delta_t
#> [1] 0.1
```

``` r
mu0
#> [[1]]
#> [1] 0 0 0
```

``` r
sigma0
#>      [,1] [,2] [,3]
#> [1,] 0.01 0.00 0.00
#> [2,] 0.00 0.01 0.00
#> [3,] 0.00 0.00 0.01
```

``` r
sigma0_l
#> [[1]]
#>      [,1] [,2] [,3]
#> [1,]  0.1  0.0  0.0
#> [2,]  0.0  0.1  0.0
#> [3,]  0.0  0.0  0.1
```

``` r
mu
#> [[1]]
#> [1] 0 0 0
```

``` r
# first phi in the list of length n
phi[[1]]
#>            [,1]        [,2]        [,3]
#> [1,] -0.4101502  0.02987347  0.09881764
#> [2,]  0.8531253 -0.47051414  0.12907652
#> [3,] -0.2282550  0.66648281 -0.72701868
```

``` r
sigma
#>      [,1] [,2] [,3]
#> [1,]  0.1  0.0  0.0
#> [2,]  0.0  0.1  0.0
#> [3,]  0.0  0.0  0.1
```

``` r
sigma_l
#> [[1]]
#>           [,1]      [,2]      [,3]
#> [1,] 0.3162278 0.0000000 0.0000000
#> [2,] 0.0000000 0.3162278 0.0000000
#> [3,] 0.0000000 0.0000000 0.3162278
```

``` r
nu
#> [[1]]
#> [1] 0 0 0
```

``` r
lambda
#> [[1]]
#>      [,1] [,2] [,3]
#> [1,]    1    0    0
#> [2,]    0    1    0
#> [3,]    0    0    1
```

``` r
theta
#>      [,1] [,2] [,3]
#> [1,]  0.2  0.0  0.0
#> [2,]  0.0  0.2  0.0
#> [3,]  0.0  0.0  0.2
```

``` r
theta_l
#> [[1]]
#>           [,1]      [,2]      [,3]
#> [1,] 0.4472136 0.0000000 0.0000000
#> [2,] 0.0000000 0.4472136 0.0000000
#> [3,] 0.0000000 0.0000000 0.4472136
```

### Visualizing the Dynamics Without Process Noise (n = 5 with Different Initial Condition)

<img src="fig-vignettes-mvn-ct-var-no-error-1.png" width="3300" /><img src="fig-vignettes-mvn-ct-var-no-error-2.png" width="3300" /><img src="fig-vignettes-mvn-ct-var-no-error-3.png" width="3300" />

### Using the SimSSMVARIVary Function from the simStateSpace Package to Simulate Data


``` r
library(simStateSpace)
sim <- SimSSMOUIVary(
  n = n,
  time = time,
  delta_t = delta_t,
  mu0 = mu0,
  sigma0_l = sigma0_l,
  mu = mu,
  phi = phi,
  sigma_l = sigma_l,
  nu = nu,
  lambda = lambda,
  theta_l = theta_l
)
data <- as.data.frame(sim)
head(data)
#>   id time         y1          y2          y3
#> 1  1  0.0  0.2498385  0.07906124 -0.16629221
#> 2  1  0.1  0.5633032  0.01741791  0.14494905
#> 3  1  0.2 -0.2225339 -0.43546978  0.26119933
#> 4  1  0.3 -0.3063337  0.18457080 -0.62072064
#> 5  1  0.4  0.3347948  0.03868089  0.05410158
#> 6  1  0.5  0.5684380  0.33269594  0.39418663
```

``` r
plot(sim)
```

<img src="fig-vignettes-mvn-ct-var-error-1.png" width="3300" /><img src="fig-vignettes-mvn-ct-var-error-2.png" width="3300" /><img src="fig-vignettes-mvn-ct-var-error-3.png" width="3300" />

## Model Fitting

The FitCTVAR function fits a CT-VAR model on each individual $i$.





``` r
library(metaVAR)
fit <- FitCTVAR(
  data = data,
  observed = paste0("y", seq_len(k)),
  id = "id",
  time = "time",
  phi_start = phi_mu,
  sigma_start = diag(sigma),
  ncores = parallel::detectCores()
)
```

## Multivariate Meta-Analysis

The Meta function performs multivariate meta-analysis using the estimated drift matrices $\boldsymbol{\Phi}$
and the corresponding sampling variance-covariance matrix for each individual $i$.


``` r
meta <- Meta(
  fit,
  ncores = parallel::detectCores()
)
#> Running Model with 54 parameters
#> 
#> Beginning initial fit attempt
#> Running Model with 54 parameters
#> 
#>  Lowest minimum so far:  389072.55950778
#>  Not all eigenvalues of the Hessian are positive: 5131.54510994491, 4563.079540411, 3579.37834577319, 3481.27185808689, 3415.739528885, 3315.38588959263, 3230.5625604673, 3110.35197530313, 2956.16129465395, 2838.02928148347, 2791.8492998238, 2725.74733133388, 2587.91667475327, 2583.48907088455, 2581.59367222065, 2580.7672096539, 2576.71100240947, 2562.46342863074, 2557.82812008282, 2547.93100186803, 2542.16749852198, 2471.37663422507, 2461.20701397745, 2452.81981499615, 2443.22566948911, 2440.54918997451, 2432.01892753913, 2431.59644985056, 2431.5468687529, 2423.16275514955, 2378.06570408665, 2334.38332604031, 2183.28495107902, 2179.05213176276, 2178.00830839308, 1769.42897135675, 1606.05303493287, 1595.85948531044, 1568.55116227834, 1560.37589650917, 1215.89356373637, 1205.39497478486, 1204.54729312692, 1202.60256709288, 1140.60238300204, 846.198217153591, 809.514062827799, 546.633672991335, 540.438419461905, 537.545794050136, 373.436192337283, 7.01832242081199, 0.488897517023682, -2.88550451613225
#> 
#> Beginning fit attempt 1 of at maximum 1000 extra tries
#> Running Model with 54 parameters
#> 
#>  Lowest minimum so far:  389072.559504388
#>  Not all eigenvalues of the Hessian are positive: 5131.62291894519, 4563.57724487482, 3579.38278541147, 3481.27419717393, 3416.07258730918, 3315.06202771986, 3230.27120670722, 3110.20563703554, 2956.11985723378, 2838.02821635271, 2791.76254737376, 2725.33805321285, 2587.22270023334, 2583.04830919922, 2580.87933626534, 2580.54532223253, 2578.97695818147, 2562.07599731791, 2557.83112191006, 2548.01694963441, 2544.1901859215, 2471.37698164754, 2461.21243448168, 2453.01817101476, 2443.67366774653, 2441.45830190944, 2431.87509492296, 2431.81091289664, 2431.55372964753, 2428.6938184585, 2379.41198185884, 2334.91233614427, 2183.28728405657, 2178.33695845735, 2178.00605263018, 1761.52078864328, 1604.35146807767, 1595.26065879619, 1572.40182239337, 1560.85690917916, 1222.51123465344, 1205.40167882866, 1204.56208577449, 1201.42691285103, 1139.65556801558, 850.850150765866, 818.140778275246, 546.610644440288, 540.437378353888, 538.819712361341, 373.37203334571, 7.00892268554198, 0.488451433368011, -2.51916472499182
#> 
#> Beginning fit attempt 2 of at maximum 1000 extra tries
#> Running Model with 54 parameters
#> 
#>  Lowest minimum so far:  389072.559504327
#> 
#> Solution found
```



```
#> 
#>  Solution found!  Final fit=389072.56 (started at 763144810)  (3 attempt(s): 3 valid, 0 errors)
#>  Start values from best fit:
#> 9.38079763422166,129.35060758516,-141.040125287297,-106.824639151972,21.7116410792367,67.3597615337921,115.479891738202,-59.9624227177608,-15.9418369549979,36.7940873153914,-39.7645684301536,-29.9828405269755,6.03862748492698,18.9060688662051,32.3783104827311,-16.908723576732,-4.35635039566308,6.58182572647946,0.922204412958189,-0.749527930421745,-2.74552459871508,-4.49904621851573,2.96437122232626,0.586129596095114,3.36511912221873,0.235966918090676,0.339929330505501,-0.0656312945970383,-0.220600043719821,0.0210130752828479,2.99501441111823,0.624388599294946,0.280693141147133,-0.618708000890659,-0.0777752553160655,3.83949313842359,0.449589257708072,-1.83191161631841,-0.143136528844406,3.61242688536241,-0.232052221058027,-0.174530979895175,3.52000059133315,0.0480077448901618,2.7918977952062,-9.61931692522741,1.89975049315614,-0.736492377077822,1.26503842869931,-8.74183195632336,1.3459222941736,-0.0717715883711667,1.47637211400696,-9.1074489516725
```

``` r
summary(meta)
#>                  est       se         z      p        2.5%       97.5%
#> sigma_11     87.9994   1.2436   70.7644 0.0000     85.5620     90.4367
#> sigma_21   1213.4119  17.4891   69.3812 0.0000   1179.1339   1247.6898
#> sigma_31  -1323.0689  19.0730  -69.3687 0.0000  -1360.4512  -1285.6865
#> sigma_41  -1002.1003  14.4397  -69.3989 0.0000  -1030.4016   -973.7990
#> sigma_51    203.6725   2.9474   69.1027 0.0000    197.8957    209.4493
#> sigma_61    631.8883   9.1138   69.3330 0.0000    614.0255    649.7510
#> sigma_71   1083.2935  15.6145   69.3776 0.0000   1052.6897   1113.8973
#> sigma_81   -562.4954   8.1182  -69.2886 0.0000   -578.4066   -546.5841
#> sigma_91   -149.5471   2.1689  -68.9507 0.0000   -153.7981   -145.2962
#> sigma_22  18085.3845 255.5696   70.7650 0.0000  17584.4774  18586.2917
#> sigma_32 -19706.7269 278.6215  -70.7294 0.0000 -20252.8151 -19160.6387
#> sigma_42 -14921.0232 210.9058  -70.7473 0.0000 -15334.3911 -14507.6554
#> sigma_52   3030.5998  43.0284   70.4326 0.0000   2946.2657   3114.9338
#> sigma_62   9408.6576 133.1115   70.6825 0.0000   9147.7638   9669.5514
#> sigma_72  16128.7245 228.0530   70.7236 0.0000  15681.7489  16575.7002
#> sigma_82  -8378.3169 118.5871  -70.6512 0.0000  -8610.7433  -8145.8905
#> sigma_92  -2222.3742  31.6407  -70.2377 0.0000  -2284.3890  -2160.3595
#> sigma_33  21516.8583 304.0597   70.7652 0.0000  20920.9121  22112.8044
#> sigma_43  16264.8850 229.9729   70.7252 0.0000  15814.1464  16715.6236
#> sigma_53  -3307.2693  46.9447  -70.4503 0.0000  -3399.2792  -3215.2593
#> sigma_63 -10270.2914 145.2462  -70.7095 0.0000 -10554.9688  -9985.6140
#> sigma_73 -17604.4199 248.8333  -70.7479 0.0000 -18092.1241 -17116.7157
#> sigma_83   9148.9867 129.4216   70.6913 0.0000   8895.3249   9402.6484
#> sigma_93   2425.5249  34.5224   70.2594 0.0000   2357.8622   2493.1875
#> sigma_44  12322.6487 174.1348   70.7650 0.0000  11981.3507  12663.9467
#> sigma_54  -2500.2906  35.5083  -70.4143 0.0000  -2569.8856  -2430.6956
#> sigma_64  -7763.9279 109.8589  -70.6718 0.0000  -7979.2473  -7548.6085
#> sigma_74 -13311.2614 188.2299  -70.7181 0.0000 -13680.1852 -12942.3376
#> sigma_84   6914.4271  97.8769   70.6441 0.0000   6722.5919   7106.2624
#> sigma_94   1834.2080  26.1160   70.2331 0.0000   1783.0216   1885.3944
#> sigma_55    517.4480   7.3124   70.7633 0.0000    503.1160    531.7800
#> sigma_65   1580.6658  22.4399   70.4399 0.0000   1536.6843   1624.6472
#> sigma_75   2706.9759  38.4260   70.4465 0.0000   2631.6623   2782.2894
#> sigma_85  -1408.1151  19.9951  -70.4229 0.0000  -1447.3048  -1368.9253
#> sigma_95   -373.0971   5.3323  -69.9693 0.0000   -383.5482   -362.6460
#> sigma_66   4917.5619  69.4919   70.7645 0.0000   4781.3603   5053.7636
#> sigma_76   8405.0759 118.8813   70.7014 0.0000   8172.0728   8638.0790
#> sigma_86  -4374.3657  61.8760  -70.6956 0.0000  -4495.6405  -4253.0908
#> sigma_96  -1158.4000  16.4958  -70.2237 0.0000  -1190.7313  -1126.0688
#> sigma_77  14417.5367 203.7379   70.7651 0.0000  14018.2177  14816.8556
#> sigma_87  -7487.0879 105.9268  -70.6817 0.0000  -7694.7006  -7279.4752
#> sigma_97  -1985.3679  28.2584  -70.2576 0.0000  -2040.7534  -1929.9825
#> sigma_88   3906.4162  55.2028   70.7649 0.0000   3798.2208   4014.6116
#> sigma_98   1031.8242  14.6980   70.2017 0.0000   1003.0167   1060.6317
#> sigma_99    281.3179   3.9755   70.7633 0.0000    273.5261    289.1097
#> mu_1         -9.6193   0.0660 -145.8146 0.0000     -9.7486     -9.4900
#> mu_2          1.8998   0.9086    2.0908 0.0365      0.1189      3.6806
#> mu_3         -0.7365   0.9939   -0.7410 0.4587     -2.6846      1.2116
#> mu_4          1.2650   0.7479    1.6915 0.0907     -0.2007      2.7308
#> mu_5         -8.7418   0.1557  -56.1589 0.0000     -9.0469     -8.4367
#> mu_6          1.3459   0.4750    2.8334 0.0046      0.4149      2.2770
#> mu_7         -0.0718   0.8130   -0.0883 0.9297     -1.6652      1.5217
#> mu_8          1.4764   0.4234    3.4871 0.0005      0.6466      2.3062
#> mu_9         -9.1074   0.1153  -79.0222 0.0000     -9.3333     -8.8816
```
