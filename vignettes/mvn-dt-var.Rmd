---
title: "Multivariate Normal (Discrete-Time Vector Autoregressive Model)"
author: Ivan Jacob Agaloos Pesigan
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Multivariate Normal (Discrete-Time Vector Autoregressive Model)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---







## Model

The measurement model is given by
\begin{equation}
  \mathbf{y}_{i, t}
  =
  \boldsymbol{\eta}_{i, t}
\end{equation}
where $\mathbf{y}_{i, t}$
represents a vector of observed variables
and $\boldsymbol{\eta}_{i, t}$
a vector of latent variables
for individual $i$ and time $t$.
Since the observed and latent variables are equal,
we only generate data
from the dynamic structure.

The dynamic structure is given by
\begin{equation}
  \boldsymbol{\eta}_{i, t}
  =
  \boldsymbol{\alpha}
  +
  \boldsymbol{\beta}
  \boldsymbol{\eta}_{i, t - 1}
  +
  \boldsymbol{\zeta}_{i, t},
  \quad
  \mathrm{with}
  \quad
  \boldsymbol{\zeta}_{i, t}
  \sim
  \mathcal{N}
  \left(
  \mathbf{0},
  \boldsymbol{\Psi}
  \right)
\end{equation}
where
$\boldsymbol{\eta}_{i, t}$,
$\boldsymbol{\eta}_{i, t - 1}$,
and
$\boldsymbol{\zeta}_{i, t}$
are random variables,
and
$\boldsymbol{\alpha}$,
$\boldsymbol{\beta}$,
and
$\boldsymbol{\Psi}$
are model parameters.
Here,
$\boldsymbol{\eta}_{i, t}$
is a vector of latent variables
at time $t$ and individual $i$,
$\boldsymbol{\eta}_{i, t - 1}$
represents a vector of latent variables
at time $t - 1$ and individual $i$,
and
$\boldsymbol{\zeta}_{i, t}$
represents a vector of dynamic noise
at time $t$ and individual $i$.
$\boldsymbol{\alpha}$
denotes a vector of intercepts,
$\boldsymbol{\beta}$
a matrix of autoregression
and cross regression coefficients,
and
$\boldsymbol{\Psi}$
the covariance matrix of
$\boldsymbol{\zeta}_{i, t}$.

An alternative representation of the dynamic noise
is given by
\begin{equation}
  \boldsymbol{\zeta}_{i, t}
  =
  \boldsymbol{\Psi}^{\frac{1}{2}}
  \mathbf{z}_{i, t},
  \quad
  \mathrm{with}
  \quad
  \mathbf{z}_{i, t}
  \sim
  \mathcal{N}
  \left(
  \mathbf{0},
  \mathbf{I}
  \right)
\end{equation}
where
$\left( \boldsymbol{\Psi}^{\frac{1}{2}} \right) \left( \boldsymbol{\Psi}^{\frac{1}{2}} \right)^{\prime} = \boldsymbol{\Psi}$ .

## Data Generation

### Notation

Let $t = 100$ be the number of time points and $n = 100$ be the number of individuals.

Let the initial condition
$\boldsymbol{\eta}_{0}$
be given by

\begin{equation}
\boldsymbol{\eta}_{0} \sim \mathcal{N} \left( \boldsymbol{\mu}_{\boldsymbol{\eta} \mid 0}, \boldsymbol{\Sigma}_{\boldsymbol{\eta} \mid 0} \right)
\end{equation}

\begin{equation}
\boldsymbol{\mu}_{\boldsymbol{\eta} \mid 0}
=
\left(
\begin{array}{c}
  0 \\
  0 \\
  0 \\
\end{array}
\right)
\end{equation}

\begin{equation}
\boldsymbol{\Sigma}_{\boldsymbol{\eta} \mid 0}
=
\left(
\begin{array}{ccc}
  1 & 0.2 & 0.2 \\
  0.2 & 1 & 0.2 \\
  0.2 & 0.2 & 1 \\
\end{array}
\right) .
\end{equation}

Let the constant vector $\boldsymbol{\alpha}$ be given by

\begin{equation}
\boldsymbol{\alpha}
=
\left(
\begin{array}{c}
  0 \\
  0 \\
  0 \\
\end{array}
\right) .
\end{equation}

Let the transition matrix $\boldsymbol{\beta}$ be normally distributed with the following means

\begin{equation}
\left(
\begin{array}{ccc}
  0.7 & 0 & 0 \\
  0.5 & 0.6 & 0 \\
  -0.1 & 0.4 & 0.5 \\
\end{array}
\right)
\end{equation}

and covariance matrix

\begin{equation}
\left(
\begin{array}{ccc}
  0.1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0.1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0.1 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0.1 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0.1 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0.1 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0.1 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0 & 0.1 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0.1 \\
\end{array}
\right) .
\end{equation}

> **_NOTE:_**  This example depends on the development version of simStateSpace (1.2.1.9000).

The SimBetaN function from the simStateSpace package generates random transition matrices from the multivariate normal distribution. Note that the function generates transition matrices that are weakly stationary.

Let the dynamic process noise $\boldsymbol{\Psi}$ be given by

\begin{equation}
\boldsymbol{\Psi}
=
\left(
\begin{array}{ccc}
  0.1 & 0 & 0 \\
  0 & 0.1 & 0 \\
  0 & 0 & 0.1 \\
\end{array}
\right) .
\end{equation}

### R Function Arguments


``` r
n
#> [1] 100
```

``` r
time
#> [1] 100
```

``` r
mu0
#> [[1]]
#> [1] 0 0 0
```

``` r
sigma0
#>      [,1] [,2] [,3]
#> [1,]  1.0  0.2  0.2
#> [2,]  0.2  1.0  0.2
#> [3,]  0.2  0.2  1.0
```

``` r
sigma0_l
#> [[1]]
#>      [,1]      [,2]      [,3]
#> [1,]  1.0 0.0000000 0.0000000
#> [2,]  0.2 0.9797959 0.0000000
#> [3,]  0.2 0.1632993 0.9660918
```

``` r
alpha
#> [[1]]
#> [1] 0 0 0
```

``` r
# first beta in the list of length n
beta[[1]]
#>            [,1]      [,2]         [,3]
#> [1,]  0.7275387 0.2220243 -0.267871122
#> [2,]  0.4845052 0.2545494  0.009117024
#> [3,] -0.1190264 1.2335820  0.431173393
```

``` r
psi
#>      [,1] [,2] [,3]
#> [1,]  0.1  0.0  0.0
#> [2,]  0.0  0.1  0.0
#> [3,]  0.0  0.0  0.1
```

``` r
psi_l
#> [[1]]
#>           [,1]      [,2]      [,3]
#> [1,] 0.3162278 0.0000000 0.0000000
#> [2,] 0.0000000 0.3162278 0.0000000
#> [3,] 0.0000000 0.0000000 0.3162278
```

### Visualizing the Dynamics Without Process Noise (n = 5 with Different Initial Condition)

<img src="fig-vignettes-mvn-dt-var-no-error-1.png" width="3300" /><img src="fig-vignettes-mvn-dt-var-no-error-2.png" width="3300" /><img src="fig-vignettes-mvn-dt-var-no-error-3.png" width="3300" />

### Using the SimSSMVARIVary Function from the simStateSpace Package to Simulate Data


``` r
library(simStateSpace)
sim <- SimSSMVARIVary(
  n = n,
  time = time,
  mu0 = mu0,
  sigma0_l = sigma0_l,
  alpha = alpha,
  beta = beta,
  psi_l = psi_l
)
data <- as.data.frame(sim)
head(data)
#>   id time          y1         y2          y3
#> 1  1    0  1.01674499  0.9398330  0.01433374
#> 2  1    1  0.86810773  0.5165674  1.00525344
#> 3  1    2  0.79802529  0.3556262  0.63609172
#> 4  1    3  0.21573693 -0.1592141  0.84520517
#> 5  1    4 -0.37983791 -0.2781934  0.43736150
#> 6  1    5  0.08693219 -0.4071713 -0.12331487
```

``` r
plot(sim)
```

<img src="fig-vignettes-mvn-dt-var-error-1.png" width="3300" /><img src="fig-vignettes-mvn-dt-var-error-2.png" width="3300" /><img src="fig-vignettes-mvn-dt-var-error-3.png" width="3300" />

## Model Fitting

The FitDTVAR function fits a DT-VAR model on each individual $i$.





``` r
library(metaVAR)
fit <- FitDTVAR(
  data = data,
  observed = paste0("y", seq_len(k)),
  id = "id",
  ncores = parallel::detectCores()
)
```

## Multivariate Meta-Analysis

The Meta function performs multivariate meta-analysis using the estimated transition matrices $\boldsymbol{\beta}$
and the corresponding sampling variance-covariance matrix for each individual $i$.


``` r
meta <- Meta(
  fit,
  ncores = parallel::detectCores()
)
#> Running Model with 54 parameters
#> 
#> Beginning initial fit attempt
#> Running Model with 54 parameters
#> 
#>  Lowest minimum so far:  -132301.387191324
#> 
#> Solution found
```



```
#> 
#>  Solution found!  Final fit=-132301.39 (started at 19511.24)  (1 attempt(s): 1 valid, 0 errors)
#>  Start values from best fit:
#> 0.301436460992566,-0.0183097733148245,-0.0495759197880904,-0.101643878783517,-0.0322305138631177,-0.0101689884616028,0.0473937482227567,-0.0125653621883241,0.0142814705900006,0.32209122509693,-0.00920782618429262,-0.0633850840354853,-0.0325078461670218,-0.00357191758989274,-0.0266390888662137,-0.0284722849409805,0.00563179286326022,0.330699447178635,-0.00264345817505843,-0.0183915920871323,-0.0550595959420431,-0.0728524886548901,-0.00644892691233359,0.053061384374074,0.259222758688234,-0.030548108993905,-0.0591138238534729,0.00357797335981194,-0.030500317568643,-0.025130770341849,0.238444830932955,-0.0589657830386124,0.00704166403422566,-0.00813960833723214,-0.0043168892319206,0.313271962626375,-0.061666049750422,-0.0233859490578083,-0.0152844801460982,0.284843213047475,-0.0130415023890208,-0.00730292095191175,0.330508145961591,-0.083591746829128,0.254335442826828,0.57760445473455,0.45576182770029,-0.102184875541409,-0.0495678342675181,0.4919911415841,0.351863899040856,-0.0140973322484382,0.00464038783265846,0.439350813683364
```

``` r
summary(meta)
#>              est     se        z      p    2.5%   97.5%
#> sigma_11  0.0909 0.0013  70.7109 0.0000  0.0883  0.0934
#> sigma_21 -0.0055 0.0010  -5.6664 0.0000 -0.0074 -0.0036
#> sigma_31 -0.0149 0.0010 -14.6599 0.0000 -0.0169 -0.0129
#> sigma_41 -0.0306 0.0009 -33.5322 0.0000 -0.0324 -0.0288
#> sigma_51 -0.0097 0.0007 -13.0219 0.0000 -0.0112 -0.0083
#> sigma_61 -0.0031 0.0010  -3.0892 0.0020 -0.0050 -0.0011
#> sigma_71  0.0143 0.0009  15.3355 0.0000  0.0125  0.0161
#> sigma_81 -0.0038 0.0010  -3.7527 0.0002 -0.0058 -0.0018
#> sigma_91  0.0043 0.0008   5.1850 0.0000  0.0027  0.0059
#> sigma_22  0.1041 0.0015  70.7110 0.0000  0.1012  0.1070
#> sigma_32 -0.0021 0.0011  -1.9067 0.0566 -0.0042  0.0001
#> sigma_42 -0.0186 0.0009 -19.7435 0.0000 -0.0204 -0.0167
#> sigma_52 -0.0099 0.0008 -12.3839 0.0000 -0.0114 -0.0083
#> sigma_62 -0.0010 0.0011  -0.9084 0.3637 -0.0030  0.0011
#> sigma_72 -0.0094 0.0010  -9.5459 0.0000 -0.0114 -0.0075
#> sigma_82 -0.0089 0.0011  -8.2542 0.0000 -0.0111 -0.0068
#> sigma_92  0.0016 0.0009   1.7492 0.0803 -0.0002  0.0033
#> sigma_33  0.1119 0.0016  70.7109 0.0000  0.1088  0.1150
#> sigma_43  0.0047 0.0010   4.9646 0.0000  0.0029  0.0066
#> sigma_53 -0.0042 0.0008  -5.0912 0.0000 -0.0058 -0.0026
#> sigma_63 -0.0177 0.0011 -15.8521 0.0000 -0.0199 -0.0155
#> sigma_73 -0.0262 0.0011 -24.8390 0.0000 -0.0283 -0.0241
#> sigma_83 -0.0012 0.0011  -1.1145 0.2651 -0.0034  0.0009
#> sigma_93  0.0168 0.0009  17.9479 0.0000  0.0150  0.0186
#> sigma_44  0.0816 0.0012  70.7108 0.0000  0.0793  0.0838
#> sigma_54 -0.0025 0.0007  -3.6129 0.0003 -0.0039 -0.0012
#> sigma_64 -0.0139 0.0009 -14.6527 0.0000 -0.0158 -0.0121
#> sigma_74 -0.0020 0.0009  -2.3026 0.0213 -0.0037 -0.0003
#> sigma_84 -0.0048 0.0010  -5.0248 0.0000 -0.0067 -0.0029
#> sigma_94 -0.0085 0.0008 -10.7122 0.0000 -0.0100 -0.0069
#> sigma_55  0.0602 0.0009  70.7107 0.0000  0.0586  0.0619
#> sigma_65 -0.0108 0.0008 -13.2549 0.0000 -0.0124 -0.0092
#> sigma_75  0.0022 0.0007   2.9983 0.0027  0.0008  0.0037
#> sigma_85  0.0004 0.0008   0.5359 0.5920 -0.0012  0.0020
#> sigma_95 -0.0019 0.0007  -2.7853 0.0053 -0.0032 -0.0006
#> sigma_66  0.1083 0.0015  70.7109 0.0000  0.1053  0.1113
#> sigma_76 -0.0163 0.0010 -16.0322 0.0000 -0.0183 -0.0143
#> sigma_86 -0.0045 0.0011  -4.0466 0.0001 -0.0066 -0.0023
#> sigma_96 -0.0061 0.0009  -6.7631 0.0000 -0.0079 -0.0044
#> sigma_77  0.0933 0.0013  70.7109 0.0000  0.0907  0.0958
#> sigma_87 -0.0018 0.0010  -1.7674 0.0772 -0.0038  0.0002
#> sigma_97 -0.0046 0.0008  -5.4640 0.0000 -0.0062 -0.0029
#> sigma_88  0.1120 0.0016  70.7106 0.0000  0.1089  0.1151
#> sigma_98 -0.0271 0.0010 -28.2025 0.0000 -0.0289 -0.0252
#> sigma_99  0.0757 0.0011  70.7108 0.0000  0.0736  0.0778
#> mu_1      0.5776 0.0030 191.6182 0.0000  0.5717  0.5835
#> mu_2      0.4558 0.0032 141.2733 0.0000  0.4494  0.4621
#> mu_3     -0.1022 0.0033 -30.5467 0.0000 -0.1087 -0.0956
#> mu_4     -0.0496 0.0029 -17.3573 0.0000 -0.0552 -0.0440
#> mu_5      0.4920 0.0025 200.4833 0.0000  0.4872  0.4968
#> mu_6      0.3519 0.0033 106.9415 0.0000  0.3454  0.3583
#> mu_7     -0.0141 0.0031  -4.6162 0.0000 -0.0201 -0.0081
#> mu_8      0.0046 0.0033   1.3868 0.1655 -0.0019  0.0112
#> mu_9      0.4394 0.0028 159.7245 0.0000  0.4340  0.4447
```
