---
title: "Multivariate Normal (Discrete-Time Vector Autoregressive Model)"
author: Ivan Jacob Agaloos Pesigan
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Multivariate Normal (Discrete-Time Vector Autoregressive Model)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---





> **_NOTE:_**  This example depends on the development version of simStateSpace (1.2.1.9000).

The SimBeta function from the simStateSpace package generates random transition matrices from the multivariate normal distribution. Note that the function generates transition matrices that are weakly stationary.



## Model

The measurement model is given by
\begin{equation}
  \mathbf{y}_{i, t}
  =
  \boldsymbol{\eta}_{i, t}
\end{equation}
where $\mathbf{y}_{i, t}$
represents a vector of observed variables
and $\boldsymbol{\eta}_{i, t}$
a vector of latent variables
for individual $i$ and time $t$.
Since the observed and latent variables are equal,
we only generate data
from the dynamic structure.

The dynamic structure is given by
\begin{equation}
  \boldsymbol{\eta}_{i, t}
  =
  \boldsymbol{\alpha}
  +
  \boldsymbol{\beta}
  \boldsymbol{\eta}_{i, t - 1}
  +
  \boldsymbol{\zeta}_{i, t},
  \quad
  \mathrm{with}
  \quad
  \boldsymbol{\zeta}_{i, t}
  \sim
  \mathcal{N}
  \left(
  \mathbf{0},
  \boldsymbol{\Psi}
  \right)
\end{equation}
where
$\boldsymbol{\eta}_{i, t}$,
$\boldsymbol{\eta}_{i, t - 1}$,
and
$\boldsymbol{\zeta}_{i, t}$
are random variables,
and
$\boldsymbol{\alpha}$,
$\boldsymbol{\beta}$,
and
$\boldsymbol{\Psi}$
are model parameters.
Here,
$\boldsymbol{\eta}_{i, t}$
is a vector of latent variables
at time $t$ and individual $i$,
$\boldsymbol{\eta}_{i, t - 1}$
represents a vector of latent variables
at time $t - 1$ and individual $i$,
and
$\boldsymbol{\zeta}_{i, t}$
represents a vector of dynamic noise
at time $t$ and individual $i$.
$\boldsymbol{\alpha}$
denotes a vector of intercepts,
$\boldsymbol{\beta}$
a matrix of autoregression
and cross regression coefficients,
and
$\boldsymbol{\Psi}$
the covariance matrix of
$\boldsymbol{\zeta}_{i, t}$.

An alternative representation of the dynamic noise
is given by
\begin{equation}
  \boldsymbol{\zeta}_{i, t}
  =
  \boldsymbol{\Psi}^{\frac{1}{2}}
  \mathbf{z}_{i, t},
  \quad
  \mathrm{with}
  \quad
  \mathbf{z}_{i, t}
  \sim
  \mathcal{N}
  \left(
  \mathbf{0},
  \mathbf{I}
  \right)
\end{equation}
where
$\left( \boldsymbol{\Psi}^{\frac{1}{2}} \right) \left( \boldsymbol{\Psi}^{\frac{1}{2}} \right)^{\prime} = \boldsymbol{\Psi}$ .

## Data Generation

### Notation

Let $t = 100$ be the number of time points and $n = 10$ be the number of individuals.

Let the initial condition
$\boldsymbol{\eta}_{0}$
be given by

\begin{equation}
\boldsymbol{\eta}_{0} \sim \mathcal{N} \left( \boldsymbol{\mu}_{\boldsymbol{\eta} \mid 0}, \boldsymbol{\Sigma}_{\boldsymbol{\eta} \mid 0} \right)
\end{equation}

\begin{equation}
\boldsymbol{\mu}_{\boldsymbol{\eta} \mid 0}
=
\left(
\begin{array}{c}
  0 \\
  0 \\
  0 \\
\end{array}
\right)
\end{equation}

\begin{equation}
\boldsymbol{\Sigma}_{\boldsymbol{\eta} \mid 0}
=
\left(
\begin{array}{ccc}
  1 & 0.2 & 0.2 \\
  0.2 & 1 & 0.2 \\
  0.2 & 0.2 & 1 \\
\end{array}
\right) .
\end{equation}

Let the constant vector $\boldsymbol{\alpha}$ be given by

\begin{equation}
\boldsymbol{\alpha}
=
\left(
\begin{array}{c}
  0 \\
  0 \\
  0 \\
\end{array}
\right) .
\end{equation}

Let the transition matrix $\boldsymbol{\beta}$ be normally distributed with the following means

\begin{equation}
\left(
\begin{array}{ccc}
  0.7 & 0 & 0 \\
  0.5 & 0.6 & 0 \\
  -0.1 & 0.4 & 0.5 \\
\end{array}
\right)
\end{equation}

and covariance matrix

\begin{equation}
\left(
\begin{array}{ccc}
  0.1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0.1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0.1 & 0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0.1 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0.1 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0.1 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0.1 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0 & 0.1 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0.1 \\
\end{array}
\right) .
\end{equation}

Let the dynamic process noise $\boldsymbol{\Psi}$ be given by

\begin{equation}
\boldsymbol{\Psi}
=
\left(
\begin{array}{ccc}
  0.1 & 0 & 0 \\
  0 & 0.1 & 0 \\
  0 & 0 & 0.1 \\
\end{array}
\right) .
\end{equation}

### R Function Arguments


``` r
n
#> [1] 10
```

``` r
time
#> [1] 100
```

``` r
mu0
#> [[1]]
#> [1] 0 0 0
```

``` r
sigma0
#>      [,1] [,2] [,3]
#> [1,]  1.0  0.2  0.2
#> [2,]  0.2  1.0  0.2
#> [3,]  0.2  0.2  1.0
```

``` r
sigma0_l
#> [[1]]
#>      [,1]      [,2]      [,3]
#> [1,]  1.0 0.0000000 0.0000000
#> [2,]  0.2 0.9797959 0.0000000
#> [3,]  0.2 0.1632993 0.9660918
```

``` r
alpha
#> [[1]]
#> [1] 0 0 0
```

``` r
# first beta in the list of length n
beta[[1]]
#>            [,1]      [,2]         [,3]
#> [1,]  0.7275387 0.2220243 -0.267871122
#> [2,]  0.4845052 0.2545494  0.009117024
#> [3,] -0.1190264 1.2335820  0.431173393
```

``` r
psi
#>      [,1] [,2] [,3]
#> [1,]  0.1  0.0  0.0
#> [2,]  0.0  0.1  0.0
#> [3,]  0.0  0.0  0.1
```

``` r
psi_l
#> [[1]]
#>           [,1]      [,2]      [,3]
#> [1,] 0.3162278 0.0000000 0.0000000
#> [2,] 0.0000000 0.3162278 0.0000000
#> [3,] 0.0000000 0.0000000 0.3162278
```

### Visualizing the Dynamics Without Process Noise (n = 5 with Different Initial Condition)

<img src="fig-vignettes-mvn-dt-var-no-error-1.png" width="3300" /><img src="fig-vignettes-mvn-dt-var-no-error-2.png" width="3300" /><img src="fig-vignettes-mvn-dt-var-no-error-3.png" width="3300" />

### Using the SimSSMVARIVary Function from the simStateSpace Package to Simulate Data


``` r
library(simStateSpace)
sim <- SimSSMVARIVary(
  n = n,
  time = time,
  mu0 = mu0,
  sigma0_l = sigma0_l,
  alpha = alpha,
  beta = beta,
  psi_l = psi_l
)
data <- as.data.frame(sim)
head(data)
#>   id time        y1          y2         y3
#> 1  1    0 0.7735747 -0.01153632 -2.1824574
#> 2  1    1 1.0862925  0.07907093 -1.2003864
#> 3  1    2 1.5089007  1.00672089 -0.6032409
#> 4  1    3 1.6044906  0.74452120  0.3535824
#> 5  1    4 1.1835632  0.75781782  1.1939247
#> 6  1    5 0.9197950  0.28315621  1.2129460
```

``` r
plot(sim)
```

<img src="fig-vignettes-mvn-dt-var-error-1.png" width="3300" /><img src="fig-vignettes-mvn-dt-var-error-2.png" width="3300" /><img src="fig-vignettes-mvn-dt-var-error-3.png" width="3300" />

## Model Fitting

The FitDTVAR function fits a DT-VAR model on each individual $i$.





``` r
library(metaVAR)
fit <- FitDTVAR(
  data = data,
  observed = paste0("y", seq_len(k)),
  id = "id",
  ncores = parallel::detectCores()
)
```

## Multivariate Meta-Analysis

The Meta function performs multivariate meta-analysis using the estimated transition matrices $\boldsymbol{\beta}$
and the corresponding sampling variance-covariance matrix for each individual $i$.


``` r
meta <- Meta(
  fit,
  ncores = parallel::detectCores()
)
#> Running Model with 54 parameters
#> 
#> Beginning initial fit attempt
#> Running Model with 54 parameters
#> 
#>  Lowest minimum so far:  -2093.15267706924
#> 
#> Solution found
```



```
#> 
#>  Solution found!  Final fit=-2093.1527 (started at 208.35297)  (1 attempt(s): 1 valid, 0 errors)
#>  Start values from best fit:
#> 0.281807362628613,-0.0401807630926476,-0.17616478863004,-0.130745838117515,-0.0338477212560155,0.107379213063967,0.103577715463688,-0.0295148556339816,-0.0679838051654045,0.220128059886088,0.0402232870574842,-0.0840169110826829,-0.0260129915163963,0.0074117574941013,-0.0922828159069831,-0.09177638511633,-0.0232463518478983,0.245011869423617,0.0187179157112292,0.173255604092958,-0.147279609974612,0.0602837134486871,-0.0576114868666606,-0.0677424907367755,0.223112735206245,-0.0955151582194126,0.17687286660109,-0.0604907096838031,-0.0563417372236727,-0.0163266659075081,0.204642085602632,-0.0577537621155957,0.0748936841360251,0.0141480848362733,-0.0305414004003405,0.279323345373205,0.0340755548443488,0.0968932104527788,-0.0668389818398723,0.146772839280784,0.099018132589255,-0.00991267628381363,0.129718707281099,-0.0204638320094765,0.0857753141530529,0.604983702649918,0.515018456651574,-0.0137105391540844,-0.0436522060511584,0.532421253315401,0.438668907546869,-0.218108560023645,-0.0610821680755585,0.517321369480965
```

``` r
summary(meta)
#>              est     se       z      p    2.5%   97.5%
#> sigma_11  0.0794 0.0112  7.0711 0.0000  0.0574  0.1014
#> sigma_21 -0.0113 0.0064 -1.7674 0.0772 -0.0239  0.0012
#> sigma_31 -0.0496 0.0099 -5.0085 0.0000 -0.0691 -0.0302
#> sigma_41 -0.0368 0.0085 -4.3252 0.0000 -0.0535 -0.0201
#> sigma_51 -0.0095 0.0082 -1.1679 0.2428 -0.0255  0.0065
#> sigma_61  0.0303 0.0112  2.7061 0.0068  0.0083  0.0522
#> sigma_71  0.0292 0.0072  4.0447 0.0001  0.0150  0.0433
#> sigma_81 -0.0083 0.0065 -1.2835 0.1993 -0.0210  0.0044
#> sigma_91 -0.0192 0.0047 -4.0690 0.0000 -0.0284 -0.0099
#> sigma_22  0.0501 0.0071  7.0711 0.0000  0.0362  0.0639
#> sigma_32  0.0159 0.0070  2.2774 0.0228  0.0022  0.0296
#> sigma_42 -0.0132 0.0062 -2.1217 0.0339 -0.0255 -0.0010
#> sigma_52 -0.0044 0.0065 -0.6764 0.4988 -0.0170  0.0083
#> sigma_62 -0.0027 0.0086 -0.3137 0.7537 -0.0194  0.0141
#> sigma_72 -0.0245 0.0058 -4.2316 0.0000 -0.0358 -0.0131
#> sigma_82 -0.0190 0.0054 -3.4920 0.0005 -0.0297 -0.0083
#> sigma_92 -0.0024 0.0034 -0.6968 0.4859 -0.0091  0.0043
#> sigma_33  0.0927 0.0131  7.0710 0.0000  0.0670  0.1184
#> sigma_43  0.0242 0.0086  2.8041 0.0050  0.0073  0.0412
#> sigma_53  0.0474 0.0100  4.7553 0.0000  0.0278  0.0669
#> sigma_63 -0.0547 0.0129 -4.2565 0.0000 -0.0799 -0.0295
#> sigma_73 -0.0072 0.0072 -1.0031 0.3158 -0.0212  0.0069
#> sigma_83 -0.0126 0.0071 -1.7867 0.0740 -0.0264  0.0012
#> sigma_93 -0.0056 0.0047 -1.1874 0.2351 -0.0147  0.0036
#> sigma_44  0.0743 0.0105  7.0711 0.0000  0.0537  0.0949
#> sigma_54 -0.0115 0.0079 -1.4451 0.1484 -0.0270  0.0041
#> sigma_64  0.0220 0.0106  2.0714 0.0383  0.0012  0.0429
#> sigma_74 -0.0182 0.0066 -2.7360 0.0062 -0.0312 -0.0051
#> sigma_84 -0.0021 0.0062 -0.3343 0.7381 -0.0143  0.0101
#> sigma_94  0.0059 0.0042  1.4116 0.1581 -0.0023  0.0142
#> sigma_55  0.0828 0.0117  7.0710 0.0000  0.0599  0.1058
#> sigma_65 -0.0581 0.0124 -4.6695 0.0000 -0.0824 -0.0337
#> sigma_75  0.0304 0.0074  4.1160 0.0000  0.0159  0.0449
#> sigma_85  0.0017 0.0066  0.2561 0.7979 -0.0112  0.0146
#> sigma_95 -0.0135 0.0046 -2.9420 0.0033 -0.0225 -0.0045
#> sigma_66  0.1459 0.0206  7.0710 0.0000  0.1055  0.1864
#> sigma_76 -0.0039 0.0090 -0.4407 0.6594 -0.0215  0.0136
#> sigma_86  0.0209 0.0090  2.3348 0.0196  0.0034  0.0385
#> sigma_96 -0.0173 0.0061 -2.8431 0.0045 -0.0292 -0.0054
#> sigma_77  0.0549 0.0078  7.0711 0.0000  0.0396  0.0701
#> sigma_87  0.0242 0.0059  4.1330 0.0000  0.0127  0.0357
#> sigma_97 -0.0140 0.0038 -3.6498 0.0003 -0.0215 -0.0065
#> sigma_88  0.0520 0.0074  7.0711 0.0000  0.0376  0.0664
#> sigma_98 -0.0016 0.0035 -0.4540 0.6498 -0.0084  0.0052
#> sigma_99  0.0233 0.0033  7.0711 0.0000  0.0168  0.0297
#> mu_1      0.6050 0.0282 21.4679 0.0000  0.5498  0.6602
#> mu_2      0.5150 0.0224 23.0160 0.0000  0.4712  0.5589
#> mu_3     -0.0137 0.0304 -0.4504 0.6525 -0.0734  0.0460
#> mu_4     -0.0437 0.0273 -1.6016 0.1092 -0.0971  0.0098
#> mu_5      0.5324 0.0288 18.4983 0.0000  0.4760  0.5888
#> mu_6      0.4387 0.0382 11.4837 0.0000  0.3638  0.5135
#> mu_7     -0.2181 0.0234 -9.3129 0.0000 -0.2640 -0.1722
#> mu_8     -0.0611 0.0228 -2.6784 0.0074 -0.1058 -0.0164
#> mu_9      0.5173 0.0153 33.8963 0.0000  0.4874  0.5472
```
